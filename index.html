<!DOCTYPE html>
<html>

    <head>
        <title>Jarvis - Canvas</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./vendors/bootstrap431/css/bootstrap.min.css" />
        <style>
            body { margin: 0; padding: 0; background: #fff;}
            .container {margin-top: 100px;}
            #jarvis {width: 100%;}
            #output-recogniton {
                background: #f2f2f2;
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0px 0px 11px -7px rgba(0,0,0,0.6);
                border: 1px solid #ddd;
                height: 400px;
                overflow: hidden;
                overflow-y: scroll;
            }
            #output-recogniton p {
                font-size: 10px;
                line-height: 15px;
                margin: 0;
                white-space: break-spaces;

            }
        </style>
    </head>

    <body>
        <canvas id="jarvis"></canvas>
        <!--div class="container">
            <div class="row">
                <div class="col-12">
                    <p><button class="btn btn-primary">Play</button></p>
                    <canvas id="jarvis"></canvas>
                </div>
                <div class="col-12">
                    <div id="output-recogniton"></div>
                </div>
            </div>
        </div-->
        <script src="./js/jquery.js"></script>
        <script src="./vendors/bootstrap431/js/bootstrap.min.js"></script>

        <script>
            //recognition();
            function recognition() {
                var SpeechRecognition = window.SpeechRecognition ||
                                    window.webkitSpeechRecognition ||
                                    window.mozSpeechRecognition ||
                                    window.msSpeechRecognition ||
                                    window.oSpeechRecognition;

                var r = new SpeechRecognition();
                r.lang = 'pt-BR';
                r.continuous = true;

                r.onstart = function(event) { };
                r.onresult = function (event) {
                    var interim_transcript = '';
                    final_transcript = '';
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            final_transcript += event.results[i][0].transcript;
                        } else {
                            interim_transcript += event.results[i][0].transcript;
                            console.log(interim_transcript);
                        }
                    }
                    //final_transcript = capitalize(final_transcript);
                    showText(final_transcript);
                };

                r.onspeechend = function(event) { };
                r.onend = function(event) { restart(r); };
                r.onerror = function(event) { };
                r.start();
            }

            
            navigator.webkitGetUserMedia({audio:true}, function(stream){

                var canvas = document.getElementById("jarvis");
                var ctx = canvas.getContext("2d");
                var width = canvas.width = innerWidth;
                var height = canvas.height = innerHeight;

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.2;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);


                var rand = Math.random;
                ctx.fillStyle = "rgba(255,255,255,.1)";
                ctx.fillRect(0, 0, width, height);

                var circlePosition = function (rad) {
                    //return [Math.cos(rad), Math.sin(rad)];
                    return [Math.pow(Math.sin(rad), 3), -(15 * Math.cos(rad) - 5 * Math.cos(2 * rad) - 2 * Math.cos(3 * rad) - Math.cos(4 * rad))];

                };

                var scaleAndTranslate = function (pos, sx, sy, dx, dy) {
                    return [dx + pos[0] * sx, dy + pos[1] * sy];
                };

                window.addEventListener('resize', function () {
                    width = canvas.width = innerWidth;
                    height = canvas.height = innerHeight;
                    ctx.fillStyle = "rgba(255,255,255,.1)";
                    ctx.fillRect(0, 0, width, height);
                });

                var pointsOrigin = [];
                for (let i = 0; i < 2 * Math.PI; i += 0.1) {
                    pointsOrigin.push(scaleAndTranslate(circlePosition(i), 360, 360, 0, 0));
                }
                for (let i = 0; i < 2 * Math.PI; i += 0.1) {
                    pointsOrigin.push(scaleAndTranslate(circlePosition(i), 250, 250, 0, 0));
                }
                for (let i = 0; i < 2 * Math.PI; i += 0.1) {
                    pointsOrigin.push(scaleAndTranslate(circlePosition(i), 150, 150, 0, 0));
                }

                var targetPoints = [];
                var pulse = function (kx, ky) {
                    for (i = 0; i < pointsOrigin.length; i++) {
                        targetPoints[i] = [];
                        targetPoints[i][0] = kx * pointsOrigin[i][0] + width / 2;
                        targetPoints[i][1] = ky * pointsOrigin[i][1] + height / 2;
                    }
                };

                var traceCount = 50;
                var pointsCount = pointsOrigin.length;
                var e = [];
                for (i = 0; i < pointsCount; i++) {
                    var x = rand() * width;
                    var y = rand() * height;
                    e[i] = {
                        vx: 0,
                        vy: 0,
                        R: 2,
                        speed: rand() + 5,
                        q: ~~(rand() * pointsCount),
                        D: 2 * (i % 2) - 1,
                        force: 0.2 * rand() + 0.7,
                        f: "hsla(0," + ~~(40 * rand() + 60) + "%," + ~~(60 * rand() + 20) + "%,.3)",
                        trace: []
                    };
                    for (var k = 0; k < traceCount; k++) e[i].trace[k] = {x: x, y: y};
                }

                var config = {
                    traceK: 0.4,
                    timeDelta: 0.01
                };


                var time = 0;
                javascriptNode.onaudioprocess = function() {
                    var array =  new Float32Array(analyser.frequencyBinCount);
                    analyser.getFloatTimeDomainData(array);

                    var n = -Math.cos(time);
                    pulse((1 + n) * .5, (1 + n) * .5);
                    time += ((Math.sin(time)) < 0 ? 9 : (n > 0.8) ? .2 : 1) * config.timeDelta;
                    ctx.fillStyle = "rgba(0,0,0,.1)";
                    ctx.fillRect(0, 0, width, height);
                    for (i = e.length; i--;) {
                        var u = e[i];
                        var q = targetPoints[u.q];
                        var dx = u.trace[0].x - q[0];
                        var dy = u.trace[0].y - q[1];
                        var length = Math.sqrt(dx * dx + dy * dy);
                        if (10 > length) {
                            if (0.95 < rand()) {
                                u.q = ~~(rand() * pointsCount);
                            }
                            else {
                                if (0.99 < rand()) {
                                    u.D *= -1;
                                }
                                u.q += u.D;
                                u.q %= pointsCount;
                                if (0 > u.q) {
                                    u.q += pointsCount;
                                }
                            }
                        }
                        u.vx += -dx / length * u.speed;
                        u.vy += -dy / length * u.speed;
                        u.trace[0].x += u.vx;
                        u.trace[0].y += u.vy;
                        u.vx *= u.force;
                        u.vy *= u.force;
                        for (k = 0; k < u.trace.length - 1;) {
                            var T = u.trace[k];
                            var N = u.trace[++k];
                            N.x -= config.traceK * (N.x - T.x);
                            N.y -= config.traceK * (N.y - T.y);
                        }
                        ctx.fillStyle = u.f;
                        for (k = 0; k < u.trace.length; k++) {
                            ctx.fillRect(u.trace[k].x, u.trace[k].y, 1, 1);
                        }
                    }
                    //ctx.fillStyle = "rgba(255,255,255,1)";
                    //for (i = u.trace.length; i--;) ctx.fillRect(targetPoints[i][0], targetPoints[i][1], 2, 2);

                    //window.requestAnimationFrame(loop, canvas);
                 
                    


                    
                }

            }, function(e){ console.log(e); });


            var paleta = ["#000", "#fff", "#0061ff", "#ff0000", "#f2ff00", "#00ff26", "#00faff", "#ff00d0"];
            function colorRandom(){
                return paleta[Math.floor(Math.random()*paleta.length)];
            }

            function randomTen(min, max) {
                return Math.round((Math.random() * (max-min) + min));
            }

            function canvasResize(canvas, ctx){
                xm = $(window).width();
                ym = $(window).height();

                $("#jarvis").width(xm);
                $("#jarvis").height(ym);
                canvas.width = xm;
                canvas.height = ym;

                ctx.clearRect(0, 0, xm, ym);

                var mgt = $(window).height()-ym-2;
                if(mgt > 0) mgt/2;
                $("#jarvis").css("margin-top", mgt);
            }



        </script>
    </body>

</html>