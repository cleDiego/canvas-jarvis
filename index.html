<!DOCTYPE html>
<html>

    <head>
        <title>Jarvis - Canvas</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./vendors/bootstrap431/css/bootstrap.min.css" />
        <style>
            body { margin: 0; padding: 0; background: #fff; }
            #jarvis {height: 200px;}
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col-6">
                    <canvas id="jarvis"></canvas>
                </div>
                <div class="col-6">
                    <div class="output-recogniton">=></div>
                </div>
            </div>
        </div>
        <script src="./js/jquery.js"></script>
        <script src="./vendors/bootstrap431/js/bootstrap.min.js"></script>

        <script>

            recognition();
            function recognition() {
                const output = $('#output-recogniton');
                var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
                var recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR';
                recognition.continuous = true;

                recognition.onstart = function() {
                    console.log("Start Recognition.");
                };

                recognition.onspeechend = function() {
                    // when user is done speaking
                    console.log("Stop Recognition.");
                    recognition.stop();
                }

                recognition.onresult = function(event) {
                    var transcript = event.results[0][0].transcript;
                    var confidence = event.results[0][0].confidence;
                    output.append("<p><b>Text:</b> " + transcript + "<br/> <b>Confidence:</b> " + confidence*100+"%</p>");
                };

                recognition.start();
            }
                        //https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3
            navigator.webkitGetUserMedia({audio:true}, function(stream){

                canvas = document.getElementById("jarvis");
                canvasContext = canvas.getContext("2d");

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(1024, 1, 1);
                analyser.fftSize = 1024;
                analyser.smoothingTimeConstant = 1;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    var array =  new Float32Array(analyser.frequencyBinCount);
                    analyser.getFloatTimeDomainData(array);

                    canvas.width = array.length;

                    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
                    canvasContext.beginPath();

                    for (let i = 0; i < array.length; i++) {
                        const x = i;
                        const y = (0.5 + (array[i] / 2)) * canvas.height;
                        if (i == 0) {
                            canvasContext.moveTo(x, y);
                        } else {
                            canvasContext.lineTo(x, y);
                        }
                    }

                    canvasContext.strokeStyle = '#000';
                    canvasContext.lineWidth = 1;
                    canvasContext.stroke();

                    /*
                    canvasContext.clearRect(0, 0, 500, 500);
                    var length = array.length;
                    var left = 0;
                    for (var i = 0; i < length; i++) {
                        canvasContext.fillStyle = '#ccc';
                        canvasContext.fillRect(left, 0, 2, array[i]);
                        left += 1;
                    }*/
                }

            }, function(e){ console.log(e); });
        </script>
    </body>

</html>