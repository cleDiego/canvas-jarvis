<!DOCTYPE html>
<html>

    <head>
        <title>Jarvis - Canvas</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./vendors/bootstrap431/css/bootstrap.min.css" />
        <style>
            body { margin: 0; padding: 0; background: #fff;}
            .container {margin-top: 100px;}
            #jarvis {width: 100%;}
            #output-recogniton {
                background: #f2f2f2;
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0px 0px 11px -7px rgba(0,0,0,0.6);
                border: 1px solid #ddd;
                height: 400px;
                overflow: hidden;
                overflow-y: scroll;
            }
            #output-recogniton p {
                font-size: 10px;
                line-height: 15px;
                margin: 0;
                white-space: break-spaces;

            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <p><button class="btn btn-primary">Play</button></p>
                    <canvas id="jarvis"></canvas>
                </div>
                <div class="col-12">
                    <div id="output-recogniton"></div>
                </div>
            </div>
        </div>
        <script src="./js/jquery.js"></script>
        <script src="./vendors/bootstrap431/js/bootstrap.min.js"></script>

        <script>
            recognition();
            function recognition() {
                var SpeechRecognition = window.SpeechRecognition ||
                                    window.webkitSpeechRecognition ||
                                    window.mozSpeechRecognition ||
                                    window.msSpeechRecognition ||
                                    window.oSpeechRecognition;

                var r = new SpeechRecognition();
                r.lang = 'pt-BR';
                r.continuous = true;

                r.onstart = function(event) { };
                r.onresult = function (event) {
                    var interim_transcript = '';
                    final_transcript = '';
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            final_transcript += event.results[i][0].transcript;
                        } else {
                            interim_transcript += event.results[i][0].transcript;
                            console.log(interim_transcript);
                        }
                    }
                    //final_transcript = capitalize(final_transcript);
                    showText(final_transcript);
                };

                r.onspeechend = function(event) { };
                r.onend = function(event) { restart(r); };
                r.onerror = function(event) { };
                r.start();
            }

            function restart(r) {
                r.start();
            }


            navigator.webkitGetUserMedia({audio:true}, function(stream){

                var canvas = document.getElementById("jarvis");
                var ctx = canvas.getContext("2d");
                var width = canvas.width = innerWidth;
                var height = canvas.height = innerHeight;
                var rand = Math.random;
                var wCenter = width/2;
                var hCenter = height/2;

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);
                //analyser.fftSize = 1024;
                //analyser.smoothingTimeConstant = 0.2;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                var circlePosition = function (rad) {
                    return [Math.cos(rad), Math.sin(rad)];
                };

                function drawEllipse(ctx, x, y, w, h) {
                    var kappa = .5522848,
                        ox = (w / 2) * kappa, // control point offset horizontal
                        oy = (h / 2) * kappa, // control point offset vertical
                        xe = x + w,           // x-end
                        ye = y + h,           // y-end
                        xm = x + w / 2,       // x-middle
                        ym = y + h / 2;       // y-middle

                    ctx.beginPath();
                    ctx.moveTo(x, ym);
                    ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
                    ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
                    ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
                    ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
                    //ctx.closePath(); // not used correctly, see comments (use to close off open path)
                    ctx.stroke();
                }

                function drawEllipseByCenter(ctx, cx, cy, w, h) {
                    drawEllipse(ctx, cx - w/2.0, cy - h/2.0, w, h);
                }

                var tracePoints = 50;
                var linesCount = Math.PI*100;
                var points = [];

                for (i = 0; i < linesCount; i++) {
                    let x = randomB(0, width);
                    let y = randomB(0, height);
                    points[i] = {
                        x: x,
                        y: y,
                        trace: []
                    };
                    for (var k = 0; k < tracePoints; k++)
                        points[i].trace[k] = {x: wCenter, y: hCenter};
                }
                console.log(points);

                function pointsMove(points) {
                    let x = points.x;
                    let y = points.y;
                }

                javascriptNode.onaudioprocess = function() {
                    var bf =  new Float32Array(analyser.frequencyBinCount);
                    analyser.getFloatTimeDomainData(bf);


                    canvasResize(canvas, ctx);

                    var slice = 2 * Math.PI / bf.length;
                    for(let i = 0; i < bf.length; i++) {
                        ctx.beginPath();
                        let angle = slice * i;
                        ctx.rect(i, hCenter, 2, bf[i]*10000);
                        ctx.fill();
                    }



                }

            }, function(e){ console.log(e); });


            var paleta = ["#000", "#fff", "#0061ff", "#ff0000", "#f2ff00", "#00ff26", "#00faff", "#ff00d0"];
            function colorRandom(){
                return paleta[Math.floor(Math.random()*paleta.length)];
            }

            function randomB(min, max) {
                return Math.round((Math.random() * (max-min) + min));
            }

            function canvasResize(canvas, ctx){
                xm = $(window).width();
                ym = $(window).height();
                $("#jarvis").width(xm);
                $("#jarvis").height(ym);

                canvas.width = xm;
                canvas.height = ym;
                width = canvas.width = innerWidth;
                height = canvas.height = innerHeight;
                wCenter = width/2;
                hCenter = height/2;


                ctx.clearRect(0, 0, xm, ym);

                var mgt = $(window).height()-ym-2;
                if(mgt > 0) mgt/2;
                $("#jarvis").css("margin-top", mgt);
            }



        </script>
    </body>

</html>