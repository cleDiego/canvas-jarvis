<!DOCTYPE html>
<html>

    <head>
        <title>Jarvis - Canvas</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./vendors/bootstrap431/css/bootstrap.min.css" />
        <style>
            body { margin: 0; padding: 0; background: #fff; }
            #jarvis {height: 200px;}
            #output-recogniton {
                background: #f2f2f2;
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0px 0px 11px -7px rgba(0,0,0,0.6);
                border: 1px solid #ddd;
                height: 400px;
                overflow: hidden;
                overflow-y: scroll;
            }
            #output-recogniton p {
                font-size: 10px;
                line-height: 15px;
                margin: 0;
                white-space: break-spaces;
                
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <canvas id="jarvis"></canvas>
                </div>
                <div class="col-12">
                    <div id="output-recogniton"></div>
                </div>
            </div>
        </div>
        <script src="./js/jquery.js"></script>
        <script src="./vendors/bootstrap431/js/bootstrap.min.js"></script>

        <script>
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            var recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = true;

            reset(recognition);
            recognition.onend = function() {
                reset(recognition);
            }

            recognition.onstart = function() { 
                console.log('Ínicio da transcrição');
            }

            recognition.onspeechend = function() {
                console.log('Fim da transcrição');
            }

            recognition.onerror = function(event) {
                if(event.error == 'no-speech') {
                    console.log('Voz não detectada');  
                };
            }
            
            final_transcript = '';
            recognition.onresult = function (event) {
                var interim_transcript = '';
                final_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                        console.log(interim_transcript);
                    }
                }
                //final_transcript = capitalize(final_transcript);
                showText(final_transcript);
            };

            function showText(text) {
                var output = $('#output-recogniton');

                var m = new Date();
                var dateString =
                    ("0" + m.getUTCDate()).slice(-2) + "/" +
                    ("0" + (m.getUTCMonth()+1)).slice(-2) + "/" +
                    m.getUTCFullYear() + " " +
                    ("0" + m.getUTCHours()).slice(-2) + ":" +
                    ("0" + m.getUTCMinutes()).slice(-2) + ":" +
                    ("0" + m.getUTCSeconds()).slice(-2);

                output.append("<p>" + dateString + " => "  + text + "</p>");
            
            }

            function reset(r) {
                r.start();
            }
                        
            //https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3
            navigator.webkitGetUserMedia({audio:true}, function(stream){

                canvas = document.getElementById("jarvis");
                canvasContext = canvas.getContext("2d");

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(1024, 1, 1);
                analyser.fftSize = 1024;
                analyser.smoothingTimeConstant = 1;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    var array =  new Float32Array(analyser.frequencyBinCount);
                    analyser.getFloatTimeDomainData(array);

                    canvas.width = array.length;

                    canvasContext.clearRect(0, 0, canvas.width, canvas.height);
                    canvasContext.beginPath();

                    for (let i = 0; i < array.length; i++) {
                        const x = i;
                        const y = (0.5 + (array[i] / 2)) * canvas.height;
                        if (i == 0) {
                            canvasContext.moveTo(x, y);
                        } else {
                            canvasContext.lineTo(x, y);
                        }
                    }

                    canvasContext.strokeStyle = '#000';
                    canvasContext.lineWidth = 1;
                    canvasContext.stroke();

                    /*
                    canvasContext.clearRect(0, 0, 500, 500);
                    var length = array.length;
                    var left = 0;
                    for (var i = 0; i < length; i++) {
                        canvasContext.fillStyle = '#ccc';
                        canvasContext.fillRect(left, 0, 2, array[i]);
                        left += 1;
                    }*/
                }

            }, function(e){ console.log(e); });
        </script>
    </body>

</html>